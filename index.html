<!DOCTYPE html>
<html>
    <head>
        <title>Nuff' Said</title>
        <link rel="icon" type="image/x-icon" href="./assets/logo.png">
        <link rel="stylesheet" href="./style.css" />
    </head>
    <div id="sidebar">
        <header id="home">
            <h3 id="title" class="text"><a href="./index.html"><img id="logo" src="./assets/logo.png">Enough Said</a></h3>
        </header>
        <div id="contents"></div>
        <footer>
            <p class="text save" id="confirm" onclick="save()">Confirm</p>
            <p class="text save" id="reset" onclick="tryReset()">Reset</p>
            <p class="text" id="reorder" onclick="doReorder()"><img id="icon" src="assets/gear.png">Reorder</p>
            <p class="text" id="credit">made by <a href="https://github.com/Axilotl17">Axilotl</a> & <a href="https://github.com/BrightShard">BrightShard</a></p>
        </footer>
    </div>
    <div id="main">
        <img id="logo" src="./assets/logo.png">
        <br>
        <h1 class="text" id="title" >Enough Said</h1>
        <h2 class="text" id="subtitle">A customizable, interactive, and improved manual for<br>
            Keep Talking and Nobody Explodes (KTaNE).<br>And that's Enough Said.</h2>
    </div>
    <script>
        //setting default order if none is found
        if(localStorage.getItem("subjectOrder") == null){
            reset()
        }

        //setting vars
        var subjectOrder = JSON.parse(localStorage.getItem("subjectOrder"))
        var subjectElements = []

        //setting html refs
        const reorder = document.getElementById("reorder")
        const contents = document.getElementById("contents")

        console.log(subjectOrder) //verbose

        //dynamically add subjects
        subjectOrder.forEach((element, index) => {
            //create menu item
            var div = document.createElement("div")
            var a = document.createElement("a")  
            var img = document.createElement("img")     
            div.onclick = function() {window.location.href = element.toLowerCase() + ".html"}
            a.className = "text subject-text"
            img.className = "icon"
            img.src  = `./assets/icons/${element.toLowerCase()}.png`
            a.appendChild(img)
            a.innerHTML = a.innerHTML + element
            a.append(document.createElement("br"))
            div.style = ""
            div.className = "subject"
            div.appendChild(a)
            div.setAttribute("name", element)
            subjectElements.push(div)
        });
        subjectElements.forEach(element => {
            contents.appendChild(element)
        });

        function doReorder() {
            //current dragging element
            let draggingEle;
            let placeholder;
            let isDraggingStarted = false;

            //pos of mouse relative to dragging element
            let x = 0;
            let y = 0;

            const swap = function (nodeA, nodeB) {
                const parentA = nodeA.parentNode;
                const siblingA = nodeA.nextSibling === nodeB ? nodeA : nodeA.nextSibling;

                // move nodeA to before the nodeB
                nodeB.parentNode.insertBefore(nodeA, nodeB);

                // move nodeB to before the sibling of nodeA
                parentA.insertBefore(nodeB, siblingA);
            }

            const mouseDownHandler = function (e) {
                draggingEle = e.target;

                //calc mouse pos
                const rect = draggingEle.getBoundingClientRect();
                x = e.pageX - rect.left;
                y = e.pageY - rect.top;

                //attach listeners
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            }

            const mouseMoveHandler = function (e) {
                const prevEle = draggingEle.previousElementSibling;
                
                const draggingRect = draggingEle.getBoundingClientRect();
                
                //set pos for dragging element
                draggingEle.style.position = 'absolute'
                draggingEle.style.top = `${e.pageY - y}px`
                draggingEle.style.left = `${e.pageX - x}px`
               
                if (!isDraggingStarted) {
                    //update
                    isDraggingStarted=true;

                    //placeholder take height of dragging element
                    placeholder = document.createElement('div');
                    placeholder.classList.add('placeholder');

                    draggingEle.parentNode.insertBefore(
                        placeholder,
                        draggingEle.nextSibling
                    )

                    //set placeholder height
                    placeholder.style.height = `${draggingRect.height}px`

                }

                const nextEle = placeholder.nextElementSibling;

                //literal edge cases

                //moves item to top
                if (prevEle && isAbove(draggingEle, prevEle)) {
                    // prevEle              -> placeholder
                    // draggingEle          -> draggingEle
                    // placeholder          -> prevEle
                    swap(placeholder, draggingEle)
                    swap(placeholder, prevEle)
                }

                //moves item to bottom
                if (nextEle && isAbove(nextEle, draggingEle)) {
                    // draggingEle          -> nextEle
                    // placeholder          -> placeholder
                    // nextEle              -> draggingEle
                    swap(nextEle, placeholder);
                    swap(nextEle, draggingEle);
                }
            }

            const mouseUpHandler = function () {
                //remove placeholder
                placeholder && placeholder.parentNode.removeChild(placeholder);

                //reset flag
                isDraggingStarted = false;

                //remove pos styles
                draggingEle.style.removeProperty('top');
                draggingEle.style.removeProperty('left');
                draggingEle.style.removeProperty('position');

                x = null
                y = null
                draggingEle = null

                //remove handlers of 'mousemove' and 'mouseup'
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            }

            const isAbove = function(nodeA, nodeB) {
                //get bounding rect of nodes
                const rectA = nodeA.getBoundingClientRect();
                const rectB = nodeB.getBoundingClientRect();

                return (rectA.top + rectA.height)/2 < (rectB.top + rectB.height)/2
            }

            subjectElements.forEach(element => {
                element.classList.add("draggable")
                element.addEventListener('mousedown', mouseDownHandler)
                element.onclick = ""
                element.childNodes[0].style.pointerEvents = "none"
            });

            reorder.style.display = "none"
            document.getElementById("confirm").style.display = "block"
            document.getElementById("reset").style.display = "block"
        }

        function save() {
            subjects = document.getElementsByClassName("subject")
            for(var i = 0; i < subjects.length; i++) {
                subjectOrder[i] = subjects[i].getAttribute("name")
                localStorage.setItem("subjectOrder", JSON.stringify(subjectOrder))
                window.location.reload()
            }
        }
        function tryReset() {
            if(confirm("Are you sure you would like to reset order?")) {
                reset()
                window.location.reload()
            }
        }
        function reset() {
            var subjectOrder = ["Wires", "The Button", "Keypads", "Simon Says", "Who's on First", "Memory", "Morse Code", "Complicated Wires", "Wire Sequences", "Mazes", "Passwords", "Knobs"]
            localStorage.setItem("subjectOrder", JSON.stringify(subjectOrder))
        }
    </script>
</html>
